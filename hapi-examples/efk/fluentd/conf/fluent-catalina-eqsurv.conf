<system>
  workers 1
</system>

<worker 0>
  <source>
    @type tail
    path /fluentd/log/logs/*/eqsurv*/*,/fluentd/log/logs/*/catalina*/*
    path_key file_path
    read_from_head true

    <parse>
      @type multiline
      format_firstline /^\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2},\d{3}|\d{2}-[A-Za-z]{3}-\d{4}\s\d{2}:\d{2}:\d{2}\.\d{3}/
      format1 /((?<timestamp_1>\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2},\d{3})\s\[(?<thread>[^\]]+)\]\s*(?<log_level>[A-Z]+)\s*(?<class>\S+):(?<line>\d+)\s*-\s*(?<message>.*)$)?/
      format2 /((?<timestamp_2>\d{2}-[A-Za-z]{3}-\d{4}\s\d{2}:\d{2}:\d{2}.\d{3})\s*(?<log_level>[^\s]+)\s*\[(?<thread>[^\]]+)\]\s*(?<class>[^\s]+)\.(?<method>[^\s]+)\s\[.*\]\s(?<status>ENTER|EXIT|SQL\s*LOG)\s*:\s*(?<message>.+)$)?/
      format3 /((?<timestamp_1>\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2},\d{3})\s*\[(?<thread>[^\]]+)\]\s*(?<log_level>[^\s]+)\s*(?<class>\S+):(?<line>\d+)\s*-\s*\[(?<sql_type>(?:[^\]])+)\]\s*(?<message>.*)$)?/
    </parse>

    @label @EQSURV_CATALINA
    tag eqsurv_catalina.logs
  </source>

  <label @EQSURV_CATALINA>
    <filter eqsurv_catalina.logs>
      @type record_transformer
      enable_ruby true
      <record>
        @timestamp ${record.has_key?("timestamp_1") ? Time.strptime(record["timestamp_1"], "%Y-%m-%d %H:%M:%S,%L").strftime("%Y-%m-%dT%H:%M:%S%z") : Time.strptime(record["timestamp_2"], "%d-%b-%Y %H:%M:%S.%L").strftime("%Y-%m-%dT%H:%M:%S%z")}
        customer_name ${record['file_path'].match('\/([^\/]+)\/[^\/]+\/[^\/]+\.[^.\/]+$')[1]}
        log_type      ${record['file_path'].match('\/([^\/]+)\/[^\/]+\.[^.\/]+$')[1].split(/[._ !@#$%^&-]/).first.downcase()}
      </record>
      remove_keys timestamp_1, timestamp_2
    </filter>

    <match eqsurv_catalina.logs>
      @type copy
      <store>
        @type elasticsearch
        host elasticsearch
        port 9200
        logstash_format true
        logstash_prefix eqsurv-manager-catalina-log
        logstash_dateformat %Y%m%d
        include_tag_key true
        tag_key @log_name
        type_name eqsurv_log
        flush_interval 2s
      </store>
      <store>
        @type stdout
      </store>
    </match>
  </label>
</worker>
